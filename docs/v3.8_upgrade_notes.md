# Worksheet Engine v3.8 Upgrade Notes

**Date:** 2026-02-11
**Commits:** `4478f50` (v3.8 upgrade), `94ad131` (hardening fixes) on `main`
**File changed:** `backend/app/api/worksheets.py`

---

## What Changed

### 1. System Prompt — Complete Rewrite

**Before:** Three separate prompt sources (`SYSTEM_PROMPT` constant, `build_system_prompt()`, `build_visual_instructions()`) with basic rules and simple output format.

**After:** Single `build_system_prompt()` function that builds the full v3.8 prompt dynamically based on region, problem_style, visual applicability, and logic_tags.

The v3.8 prompt includes:
- **Core Quality Rules** — grade-safe, no personal data, clarity, no ambiguity, difficulty accuracy, no repetition, exact question count
- **Pedagogical Structure** — warm-up (1-2 easy) → core practice (medium) → challenge (1-2 hard)
- **Difficulty Definitions** — easy=recall/single-step, medium=1-2 step, hard=reasoning/multi-step
- **Answer Rules** — exact vs example, true/false lowercase, open-ended handling with sample_answer + grading_notes
- **Parent Support** — skill_focus, common_mistake, parent_tip at worksheet level
- **Regional Context** — India (Rupees, Indian names) or UAE (AED, UAE names), injected dynamically
- **Visual Mode Rules** — conditional section for Math Grades 1-3 with object_group ≤ 20 constraint
- **Logic Tag Guidance** — numerical, vocabulary, reading_comprehension, observation, diagrammatic

**User prompt** trimmed to 3 lines (grade/subject/board + topic + difficulty/count/language). All rules live in the system prompt.

**max_tokens** bumped from 4096 → 8192 to accommodate richer output format.

### 2. Extended Pydantic Models

**Question** — 4 new optional fields:
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `difficulty` | `str \| None` | `None` | Per-question difficulty (easy/medium/hard) |
| `answer_type` | `str \| None` | `None` | "exact" for objective, "example" for open-ended |
| `sample_answer` | `str \| None` | `None` | Sample answer for open-ended questions |
| `grading_notes` | `str \| None` | `None` | Grading guidance for open-ended questions |

**Worksheet** — 3 new optional fields:
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `skill_focus` | `str` | `""` | Core skill being practiced |
| `common_mistake` | `str` | `""` | Typical mistake children make |
| `parent_tip` | `str` | `""` | Actionable guidance for parents |

### 3. Backward-Compatible Parsing + Schema Consistency

New `parse_question()` helper auto-fills defaults when fields are missing:
- `difficulty` → falls back to request-level difficulty
- `answer_type` → `"exact"` if `correct_answer` is present, else `"example"`
- `sample_answer` → `None` (also force-nullified when `answer_type=="exact"` for token efficiency)
- `grading_notes` → `None`
- Worksheet parent fields → `""`

**Type enum enforcement** (added in `94ad131`):
- `Question.type` must be one of: `multiple_choice`, `fill_blank`, `short_answer`, `true_false`
- If the model outputs a visual type name as the question type (e.g. `type:"number_line"`), `_fixup_question_types()` remaps it:
  - Moves the value to `visual_type`
  - Sets `type` to `fill_blank` (if `correct_answer` present) or `short_answer`
- Any other unknown type is clamped to `short_answer`
- This fixup runs on raw JSON **before** validation in both `generate` and `regenerate` endpoints

This means:
- Old saved worksheets load fine (new fields get defaults)
- PDF export works unchanged (only reads `correct_answer`, `explanation`, `options`)
- Frontend ignores unknown fields safely

### 4. Visual Mode Enforcement

New `enforce_visual_rules()` runs after `json.loads`:
- **object_group counts > 20** — auto-converted to `number_line` with computed start/end/step/highlight (prevents null renders in UI)
- **Multiplication support** (added in `94ad131`) — `object_group.operation` now allows `"x"` in addition to `"+"` and `"-"`. When operation is `"x"` and the product exceeds 20, auto-converts to `number_line` (product as highlight)
- **Drawable labels** — prompt now instructs: use simple nouns ("apples", "stars", "balls"), avoid compound phrases ("boxes of chocolates")
- **visual mode** — checks ALL questions have `visual_type` + `visual_data`
- **mixed mode** — uses `ceil(n/2)` threshold (fixed in `94ad131`; was `n//2` which under-counted). E.g. 7 questions → requires 4 visual (not 3)
- Unfixable coverage issues are fed to the repair call

### 5. Validation + Repair

New `validate_worksheet_data()` checks:
- Required keys exist (question text must be non-empty)
- **Type enum correctness** — `type` must be in `{multiple_choice, fill_blank, short_answer, true_false}` (added in `94ad131`)
- MCQ `correct_answer` must be one of the `options`
- true_false `correct_answer` must be lowercase `"true"` or `"false"`
- Open-ended detection (write/describe/explain/लिखिए/बताइए) → must have `correct_answer=null`, `answer_type="example"`
- Personal data ban — regex patterns for "father's name", "phone number", "address" in English and Hindi
- **object_group count ≤ 20** per group (added in `94ad131`)
- **operation allowed values** — must be `+`, `-`, or `x` (added in `94ad131`)
- **Visual ratio for mixed/visual modes** — visual count vs `ceil(n/2)` or `n` (added in `94ad131`)

New `attempt_repair()`:
- Makes ONE repair call (temperature 0.3) with the issue list + original JSON
- Re-parses and re-enforces visual rules on repaired output
- If repair fails, original (best-effort) data is used

### 6. Token Cost

- Normal flow: **1 API call** (generation)
- Only on validation/visual failure: **2 API calls** (generation + repair)
- No speculative or preventive extra calls
- `sample_answer` is force-set to `null` for `answer_type=="exact"` questions — avoids wasting tokens on redundant data

---

## What Was NOT Changed

- **Frontend** — no changes; new fields are ignored safely
- **Database** — no migration needed; new question fields ride in existing `questions` JSONB column; worksheet-level parent fields are not persisted (returned in generation response only)
- **PDF service** (`backend/app/services/pdf.py`) — untouched, works with old and new schema
- **Save/List/Get/Delete endpoints** — unchanged, backward compatible
- **Subscription/analytics endpoints** — unchanged
- **`backend/app/models/worksheet.py`** — left as-is (unused, not imported anywhere)

---

## How to Verify

1. Generate a worksheet via POST `/api/worksheets/generate` — response should include `skill_focus`, `common_mistake`, `parent_tip` at worksheet level, and `difficulty`, `answer_type` per question
2. Save and reload a worksheet — old fields preserved, new fields present if generated with v3.8
3. Export PDF — works identically for old and new worksheets
4. Test visual mode (Math, Grade 1-3, problem_style="visual") — all questions should have visual_type + visual_data, no object_group counts > 20
5. Test mixed mode (problem_style="mixed", 10 questions) — at least 5 should have visual fields (ceil(10/2))
6. Verify `type` field — every question must be one of: multiple_choice, fill_blank, short_answer, true_false. Never a visual type name
7. Test multiplication visual — object_group with operation "x" should auto-convert to number_line when product > 20
8. Verify token efficiency — questions with `answer_type="exact"` should have `sample_answer=null`
9. Load an old saved worksheet — `Question(**old_data)` works, new fields default to None
